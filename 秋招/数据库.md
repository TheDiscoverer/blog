## 数据库
 
### 事务
事务是由一系列对数据库进行操作的集合组成的最小工作单元

#### ACID特性

1. 原子性 整体，不可分割

2. 一致性 事务执行后不会破坏数据库的完整性，也就是从一个正确的状态转换到另一个正确的状态。

3. 持久性 事务执行结束后，对数据库的更改永久写到数据库中，结果不会被撤销。

4. 隔离性 并发执行时互不影响

#### ACID特性如何保证

1. undo保证原子性和一致性。InnoDB中当事务对数据库进行修改的时候，InnoDB后生成对应的undo log，如果事务执行失败或者调用了rollback导致事务需要回滚时，便利用undo log中的信息将数据会滚到修改之前的样子。undo log书与逻辑日志，当发生会滚时，执行undo log中相反的sql 语句。 

2. redo保证持久性。执行某事务时，首先将要修改的数据从磁盘中拷贝到内存，然后对内存数据进行修改。接着将事务的日志写入到redo缓冲区，然后将redo缓存写入到redo文件进行持久化。最后在提交commit，将修改的数据写入到磁盘中。这样当数据写入磁盘失败时候可以利用redo文件进行恢复。

3. 锁以及MVCC保证隔离性


#### 事务并发执行产生的问题

1. 脏读，读取未提交的数据。当事务A修改了数据X，但还没有提交，此时事务B读取了X，接着事务A进行了撤消。

2. 不可重复读，事务B读取了数据X，事务A对数据X进行了修改，事务B接着读取X，导致前后不一致。

3. 幻读，事务A第一次读不存在，然后事务B insert了一条数据，事务A再次读时又出现了。


### 索引

#### 索引数据结构

1. B+树索引

所有数据记录都是按照键值大小顺序存放在同一层的叶子结点，各个叶子结点通过链表进行连接。非叶子结点交替存储节点指针和kev，key从左到右升序排列。每个指针指向的节点里所有的key都小于等于指针右边的key，大于指针左边的key。

2. B树和B+树的区别

	- B树中非叶子结点也存储数据记录，而B+树中非叶子结点置存储key以及指向其他结点的指针。因此B+树能够保证每个结点能够存储更多的指针，树的层高能够进一步压缩，使得检索时间更短。

	- 叶子结点采用链表形式，方便顺序遍历多个叶子结点。而B树还需要遍历多个非叶子结点，时间比较慢。

	- 对于B树，如果经常访问的数据存在离根节点比较近的节点，访问效率比较高。

3. 哈希索引

InnoDB会自适应创建哈希索引，以O1的时间复杂度实现快速查找。这样会丢失数据的有序性。

4. 全文索引

##### 索引优化

1. SQL语句中索引独立，不能是表达式的一部分，不然索引会失效。

`SELECT actor_id FROM sakila.actor WHERE actor_id + 1 = 5;`

2.  使用多列索引

CREATE INDEX PersonIndex ON Person (LastName, FirstName)

使用多列索引后，当我们判断条件有多个时候，首先根据第一个条件过滤掉不符合条件的行，然后根据第二个条件在前一部分过滤的基础上再进行一次过滤。

3. 最左原则

基于多列索引进行数据查询时，让查询条件能够尽可能多的匹配多列索引的左边连续几列。